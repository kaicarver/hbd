<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
	  Display a birthday message hidden in any text.
	  BUGS:
	    should not allow word wrap inside a word with a highlight
	  TODO:
        add Share button
        have a More button with extra features
        let change message
        let change text (based on copy/paste, or any URL)
		animation, slow reveal
		sound
		at end eliminate words that do not have matching letters
	-->
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <title>Astrid Happy Birthday 2019</title>
    <style>
	body { text-align: center; margin: 10vmin; margin-top: 5vmin; margin-bottom: 5vmin; font-size: calc(16px + 1vmax); }
	#display {
		font-size: calc(14px + 1vmax);
		margin: 5vmin;
	}
	button {
		font-size: calc(14px + 1vmax);
	}
	.highlight {
		font-size: calc(24px + 1vmax);
		display: inline-block;
		width: calc(24px + 1vmax);
		line-height: 90%;
		white-space: nowrap;
	}
	.highlight2 {
		display: inline-block;
		padding-left: 0.5vmax;
		padding-right: 0.5vmax;
	}
	.word0 { background-color: yellow; }
	.word1 { background-color: lightgreen; }
	.word2 { background-color: pink; }
	.example {
		display: none;
	}
	#signature {
		font-size: 4vmin;
		font-style: italic;
		animation: 1s ease 0s normal forwards 1 fadein;
		text-align: center;
	}
	@keyframes fadein{
		0% { opacity:0; }
		100% { opacity:1; }
	}
	#credits {
		margin-top: 2vmin;
		font-style: normal;
		font-size: 2vmin;
		text-align: center;
	}
    </style>
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
  </head>
  <body>
  <script>
	"use strict";
	window.onload = initLoad;
	var textModified = false;
	function initLoad() {
	  setText();
	  textModified = true; // don't rotate text choice this time
	  sequentialRun(100, findMessage);
	  sequentialRun(50, signature);
	  sequentialRun(50, credits);
	  document.getElementById('again').onclick = findMessage;
	  document.getElementById('display')
		.addEventListener("input", function() { textModified = true; console.log("input event fired"); }, false);
	  document.getElementById('display')
		.addEventListener("click", function() { document.execCommand('selectAll'); console.log("click event fired"); }, false);
	}
	
	// highlight a pattern in a text
	// returns the modified text and the position past the modification
	function highlightPattern(pat, text, position, wordno) {
	  let newOffset = position;
	  let newText = text;
	  if (position >= 0) {
		let pos1 = text.indexOf(pat.toLowerCase(), position);
		let pos2 = text.indexOf(pat.toUpperCase(), position);
		let pos = (pos2 < 0 || pos1 >=0 && pos1 < pos2) ? pos1 : pos2;
		newOffset = pos;
		if (pos >= 0) {
		  let replacePat = '<span class="word' + (wordno % 3) + ' highlight">' + pat.toUpperCase() + '</span>';
		  if (pat === ' ')
			replacePat = pat; // don't highlight a space, but move ahead one word anyway
		  let offset = pos + pat.length;
		  newOffset = pos + replacePat.length;
		  newText = text.substring(0, pos) +
			replacePat +
			text.substring(offset, text.length);
		  // go to next word
		  newOffset = newText.indexOf(' ', newOffset);
		}
	  }
	  return [newText, newOffset];
	}
	function resetText() {
	  document.getElementById('display').innerHTML = document.getElementById('display').innerText;
	}
	function setText() {
	  if (textModified) {
		textModified = false;
		return;
	  }
	  if (!('counter' in setText))
		setText.counter = 0;
	  else
		setText.counter++;
	  var texts = document.getElementsByClassName("example");
	  document.getElementById('display').innerHTML = texts[setText.counter % texts.length].innerText;
	}
	// highlights a series of letters in a text, in different words
	function findMessage() {
	  setText();
	  let html = document.getElementById('display').innerText;
	  let position = 0;
	  let message = new URL(location).searchParams.get("msg")
		  || "Happy birthday Astrid";
	  let letters = message.toLowerCase().split('');
	  let wordno = 0;
	  for (const letter of letters) {
		if (letter === ' ') {
		  wordno++;
		  //continue;
		}
		[html, position] = highlightPattern(letter, html, position, wordno);
		document.getElementById('display').innerHTML = html;
	  }
	  document.getElementById('display').innerHTML = html;
	}
	function sequentialRun(delay, func) {
	  let tick = 50;
	  if (!('timestamp' in sequentialRun))
		sequentialRun.timestamp = 0;
	  sequentialRun.timestamp += timer(delay, tick);
	  setTimeout(func, sequentialRun.timestamp);
	}
    function timer(counter, tick) {
      return counter * tick;
	}
	function numberWithCommas(x) {
	  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	}
	function signature() {
	  let ageMinutes = Math.round((new Date() - new Date('June 13, 1967 12:00:00'))/(60*1000));
      document.getElementById('signature').innerHTML =
		'<span class="highlight2 word0">Happy</span> ' + numberWithCommas(ageMinutes) +
		'th <span class="highlight2 word1">birthminute</span> <span class="highlight2 word2">Astrid</span>!<br>--Kai, June 13, 2019';
    }
    function credits() {
      document.getElementById('credits').innerHTML =
        '<a href="https://github.com/kaicarver/hbd/blob/master/hbda2019.html">Source code on Github.</a>';
    }
  </script>
  <div>
	<button id="again">Click Me</button>
  </div>
  <div id="display" contenteditable="true"></div>
  <div id="signature"></div>
  <div id="credits"></div>
  <div class="example">
Zongzi ([tsʊ̂ŋ.tsɨ]; Chinese: 粽子) is a traditional Chinese rice dish made of glutinous rice stuffed with different fillings and wrapped in bamboo leaves, generally of the species Indocalamus tessellatus, sometimes, with reed leaves, or other large flat leaves. They are cooked by steaming or boiling. In the Western world, they are also known as rice dumplings or sticky rice dumplings.

As it diffused to other regions of Asia over many centuries, zongzi became known by various names in different languages and cultures, including Pya Htote in Burmese-speaking areas (such as Myanmar), Nom Chang in Cambodia, Bachang in Indonesia, Khanom Chang in Laos, and Ba-chang in Thailand.

In Singapore, Indonesia, Taiwan, and Malaysia, zongzi is known as bakcang, bacang, or zang (from Hokkien Chinese: 肉粽; Pe̍h-ōe-jī: bah-chàng), as Hokkien is commonly used among overseas Chinese. Similarly, zongzi is more popularly known as machang among Chinese Filipinos in the Philippines.
  </div>
  <div class="example">
When, in the course of human events, it becomes necessary for one people to dissolve the political bonds which have connected them with another, and to assume among the powers of the earth, the separate and equal station to which the laws of nature and of nature's God entitle them, a decent respect to the opinions of mankind requires that they should declare the causes which impel them to the separation.

We hold these truths to be self-evident, that all men are created equal, that they are endowed by their Creator with certain unalienable rights, that among these are life, liberty and the pursuit of happiness. That to secure these rights, governments are instituted among men, deriving their just powers from the consent of the governed. 
  </div>
  <div class="example">
Two roads diverged in a yellow wood,
And sorry I could not travel both
And be one traveler, long I stood
And looked down one as far as I could
To where it bent in the undergrowth;

Then took the other, as just as fair,
And having perhaps the better claim,
Because it was grassy and wanted wear;
Though as for that the passing there
Had worn them really about the same,

And both that morning equally lay
In leaves no step had trodden black.
Oh, I kept the first for another day!
Yet knowing how way leads on to way,
I doubted if I should ever come back.

I shall be telling this with a sigh
Somewhere ages and ages hence:
Two roads diverged in a wood, and I—
I took the one less traveled by,
And that has made all the difference.
  </div>
  </body>
</html>
